【事实表】作为数据仓库维度建模的核心，紧紧围绕着【业务过程】来设计，
通过获取描述业务过程的【度量】来表达业务过程，包含了引用的维度和与业务过程有关的度量。

# 1、三种事实表概述
事实表有三种类型 : 事务事实表、周期快照事实表和累积快照事实表。

## 1.1 事务事实表
事务事实表是一类常见的事实表类型，主要用于**记录与业务对象相关的事务性数据**，也称之为**事务型事实表**或**基本事实表**。

随着业务的不断发展，系统会不断产生事务性数据，例如交易流水、操作日志、出库入库记录等，这些**数据在创建后就不会再变化**，
因此事务事实表的每条记录表示一个瞬时的事件。
在数据仓库中，这类数据通常包含与业务对象相关的度量、日期、事实类型等字段信息。

为了提高查询效率和性能，事务事实表通常会通过聚集操作进行优化。
聚集操作就是通过对事实表中的度量进行聚合，生成一张聚集表来快速查询和提高查询性能。
聚集表通常包含常见的聚合函数，例如SUM、AVG等，可以加快数据计算和数据分析。

事务事实表常用于记录**实时/近实时**产生的事务性数据，通常需要实时地获取到数据并进行数据分析和处理，交易系统和设备监控系统等场景都是很好的应用场景。

| 编号 | 对外业务编号 | 订单编号 | 用户编号 | 支付交易流水编号 | 支付金额 | 支付类型 | 支付时间                |
|----|--------|------|------|----------|------|------|---------------------|
| 1  | 1001   | 2001 | 3001 | 4001     | 100  | 1    | 2021-01-01 10:00:00 |
| 2  | 1002   | 2002 | 3002 | 4002     | 200  | 2    | 2021-01-01 10:10:00 |
| 3  | 1003   | 2003 | 3003 | 4003     | 300  | 3    | 2021-01-01 10:20:00 |


## 1.2 周期快照事实表
周期快照事实表是一类常见的事实表类型，主要用于记录与业务对象相关的周期性变化数据，也称为快照事实表或周期事实表。

周期快照事实表的特点是随着业务周期性的推进而变化，记录某个时间段内的业务数据度量和状态度量的变化。
周期性通常以年、月、周、日等为单位进行统计，业务对象可以是各个维度的组合。
常用于统计与业务对象相关的周期性数据，例如年度销售额、季度利润等，同时也可以用于分析和预测未来趋势和变化。

周期快照事实表通常使用周期+状态度量的组合方式来记录数据，例如年累计订单数，每天是周期，订单总数是状态度量。
在数据仓库中，这类数据通常包含与业务对象相关的度量、日期、周期、状态度量等字段信息。

为了方便快速查询和分析，周期快照事实表通常使用时间戳和状态字段来记录每个度量周期内的状态。
同时，为了提高查询效率和性能，周期快照事实表也会通过聚集操作来优化。
聚集表包含常见的聚合函数，例如SUM、AVG等，可以加快数据计算和数据分析。

| 业务编号 | 卖家编号 | 年累计下单金额 | 年累计买家数 | 年累计支付金额 | 年累计支付买家数 | ... |
|------|------|---------|--------|---------|----------|-----|
| 1001 | 2001 | 709802  | 1892   | 609288  | 1858     | ... |
| 1002 | 2002 | 809802  | 2892   | 709288  | 2858     | ... |

## 1.3 累积快照事实
用来描述过程开始和结束之间的关键步骤事件，覆盖过程的整个生命周期，通常具有多个日期字段来记录关键时间点；
当过程随着生命周期不断变化时，记录也会随着过程的变化而被修改；

个人理解：要看整个生命周期的多个业务过程，比如：创建订单 → 买家付款 → 卖家发货 → 买家确认收货。
粒度是一个订单一行数据，创建订单时间，付款时间，发货时间，收货时间，分别作为一个字段，便于计算不同业务过程的时间间隔。

累积快照事实表是一类常见的事实表类型，
主要用于记录与业务对象相关的完全覆盖一个事实的生命周期、度量统计不确定周期的数据，也称为累计快照事实表或时间周期事实表。

与周期快照事实表不同，累积快照事实表没有确定的周期，而是针对一个业务对象完全覆盖一个事实的生命周期进行记录。
例如，订单状态表就是一个典型的累积快照事实表，该表记录了订单的所有状态变化，如下单、出库、发货、交付等，同时该表中的数据不断更新，需要进行随机修改。

累积快照事实表通常用于记录与某个业务对象相关的变化和状态历史，例如订单状态表、客户积分历史表等。
这些表可以用于分析和预测未来趋势和变化，从而帮助业务决策。

为了记录一个事实的生命周期中的关键时间点，累积快照事实表通常会包含多个时间字段，例如订单状态表中的订单创建时间、订单取消时间、订单完成时间等。

同时，累积快照事实表只有一条记录，针对这条记录不断进行更新。
每次更新时，旧的记录会被保留在历史记录中，以便回溯和分析。
由于记录的更新和历史版本的保留，累积快照事实表需要更大的存储空间和更长的查询时间。

| 订单编号 | 订单金额 | 订单状态 | 用户ID | 下单时间                | 支付时间                | 确认收货时间              | ... |
|------|------|------|------|---------------------|---------------------|---------------------|-----|
| 1001 | 100  | 1    | 2001 | 2021-01-01 10:00:00 | NULL                | NULL                | ... |
| 1001 | 100  | 1    | 2001 | 2021-01-01 10:00:00 | 2021-01-01 10:10:00 | NULL                | ... |
| 1001 | 100  | 1    | 2001 | 2021-01-01 10:00:00 | 2021-01-01 10:10:00 | 2021-01-01 10:20:00 | ... |

累计快照后：

| 订单编号 | 订单金额 | 订单状态 | 用户ID | 下单时间                | 支付时间                | 确认收货时间              | ... |
|------|------|------|------|---------------------|---------------------|---------------------|-----|
| 1001 | 100  | 1    | 2001 | 2021-01-01 10:00:00 | 2021-01-01 10:10:00 | 2021-01-01 10:20:00 | ... |

在文章《扫盲系列（10）：数据仓库实践之累积快照事实表的实现方式》中，详细介绍了累积快照事实表的三种实现方式。这里不做展开。

# 2、三种事实表对比
|       | 事务事实表       | 周期快照事实表        | 累积快照事实表            |
|-------|-------------|----------------|--------------------|
| 时期/时间 | 离散事务时间点     | 以有规律的、可预测的     | 用于时间跨度不确定的不断变化的工作流 |
| 日期维度  | 事务日期        | 快照日期           | 相关业务过程涉及的多个日期      |
| 粒度    | 每行代表实体的一个事务 | 每行代表某时间周期的一个实体 | 每行代表一个实体的生命周期      |
| 事实    | 事务事实        | 累积事实           | 相关业务过程事实和时间间隔事实    |
| 事实表加载 | 插入          | 插入             | 插入与更新              |
| 事实表更新 | 不更新         | 不更新            | 业务过程变更时更新          |

# 3、事实表设计 8 大原则
## 原则 1：尽可能包含所有与业务过程相关的事实
- 分析哪些事实与业务过程相关，是设计过程中非常重要的关注点；
- 在事实表中，尽量包含所有与业务过程相关的事实，即使存在冗余，由于事实通常是数字型，存储开销不会太大；

## 原则 2：只选择与业务过程相关的事实
- 如，订单的下单这个业务过程，事实表中不应该存在支付金额这个表示支付业务过程的事实；

## 原则 3：分解不可加性事实为可加的组件
- 如，订单的优惠率，应分解为订单原价金额与订单优惠金额两个事实存储在事实表中；

## 原则 4：在选择维度和事实之前必须先声明粒度
- 粒度用于确定事实表中一行所表示业务的细节层次，决定了维度模型的扩展性；
- 每个维度和事实必须与所定义的粒度保持一致；
- 设计事实表时，粒度定义越细越好，一般从最低级别的原子粒度开始；      
  - 因为原子粒度提供了最大限度的灵活性，可以支持无法预期的各种细节层次的用户需求；

## 原则 5：在同一个事实表中不能有多种不同粒度的事实
疑问：怎么判断不同事实的粒度是否相同？      
- 粒度为票一级；（实际业务中，一个订单可以同时支付多张票）
- 票支付金额和票折扣金额，两个事实的粒度为 “票级”，与定义的粒度一致；
- 订单支付金额和订单票数，两个事实的粒度为 “订单级”，属于上一层订单级数据，与 “票级” 事实表的粒度不一致，且不能进行汇总；
- 如果，以订单金额和订单票数这两个维度汇总总金额和总票数，会造成大量的重复计算；

## 原则 6：事实的单位要保持一致
- 如，订单金额、订单优惠金额、订单运费这 3 个事实，应该采用统一的计量单位，统一为元或者分，以方便使用；

## 原则 7：对事实的 null 值要处理
- 原因：在数据库中，null 值对常用数字型字段的 SQL 过滤条件都不生效；如，大于、小于、等于、大于或等于、小于或等于；
- 处理：用 0 代替 null ；

## 原则 8：使用退化维度提高事实表的易用性
- 事实表中存储各种类型的常用维度信息，较少下游用户使用时关联多个表的操作；
- 通过退化维度，可以实现对事实表的过滤查询、控制聚合层次、排序数据、定义主从关系等；
  - 易用性：对事实表，更较少关联操作、过滤查询、控制聚合层次、排序数据、定义主从关系等；

在 Kimball 的维度建模中，通常按照星形模型的方式设计，通过事实表的外键关联专门的维表，
这种方式来获取维度，谨慎使用退化维表；这与大数据领域的事实表设计不一样；    
- 思路：通过增加冗余存储，减少计算开销，提高使用效率；

# 4、事实表设计方法
Kimball 的维度模型设计 4 步法：选择业务过程、声明粒度、确定维度、确定事实；

当前的互联网大数据环境，维度模型的设计，是基于 Kimball 的四步维度建模方法进行了更进一步的改进：

- 第一步：选择业务过程及确定事实表类型

  - 思路：详细分析需求，对业务的整个生命周期进行分析，明确关键的业务步骤，从而选择与需求有关的业务过程；
  - 以实例说明：如何选择业务过程？如何确定事实表类型？      
  - 例：淘宝的一个交易订单：
    买家下单 --> 创建订单 --> 等待买家付款 --> 买家付款
    --> 等待卖家发货 --> 卖家发货 
    --> 等待买家确认支付 --> 买家确认收货 --> 交易成功

    - 【分析业务的生命周期】：如上流程，业务过程通常使用行为动词表示【业务执行的活动】；
    - 【明确关键的业务步骤】：该订单流转的业务过程有 4 个：创建订单 → 买家付款 → 卖家发货 → 买家确认收货；
    - 【根据业务需求，选择与维度建模有关的业务过程】；          
      - 如，是选择 “买家付款” 这个业务过程，还是选择 “创建订单” 和 “买家付款” 这两个业务过程，具体根据业务情况来定；
    - 【根据所选的业务过程确定事实表类型】；          
      - 如，选择 “买家付款” 这个业务过程，则事实表类型应为只包含买家付款这一个业务过程的 “单事务事实表”；
      - 如，选择了所有 4 个业务过程，并且需要分享各业务过程的时间间隔，则事实表类型应为包含了所有 4 个业务过程的 “累积快照事实表”；

- 第二步：声明粒度

  - 粒度的作用：      
    - 粒度的声明，意味着【精确定义事实表的每一行所表示的业务含义】；
    - 明确的粒度能够确保对实表中行的意思的理解不会产生混淆，【保证所有的事实按照同样的细节层次记录】；

  - 粒度的选择：**尽量选择最细级别的原子粒度，以确保事实表的应用具有最大的灵活性**；      
    - 灵活性：支持无法预期的各种细节层次的用户需求；
    - 对于订单级别，粒度可以定义为最细的订单级别；（如，父子订单，事实表的粒度可以定 “子订单级别”；）

- 第三步：确定维度

  - 完成了粒度声明，就意味着确定了主键，对应的维度组合以及相关的维度字段也可以确定了；
  - 选择维度的原则：应该选择能够描述清楚业务过程【所处的环境】的【维度信息】；      
    - 如，淘宝订单 “付款事务事实表” 中，粒度为 “子订单”，相关的维度有买家、卖家、商品、收货人信息、业务类型、订单时间等；

- 第四步：确定事实

  - 确定原则：选择与业务过程有关的所有事实，且事实的粒度要与所声明的事实表的粒度一致；
  - 思路：可以通过回答 “过程的度量是什么” 来确定；
  - 注意：将**不可加性事实**分解为**可加的组件**；（分解的原则：可以通过分解后的可加的属性值，计算得到不可加性事实）

参考文献：阿里巴巴大数据之路