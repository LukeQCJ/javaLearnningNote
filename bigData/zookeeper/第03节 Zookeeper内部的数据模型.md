# 三、Zookeeper内部的数据模型

ZooKeeper的数据模型，在结构上和标准文件系统的非常相似，
拥有一个层次的命名空间，都是采用树形层次结构，ZooKeeper树中的每个节点被称为—ZNode。
和文件系统的目录树一样，ZooKeeper树中的每个节点可以拥有子节点。但也有不同之处：

- ZNode兼具文件和目录两种特点,既像文件一样维护着数据、元信息、ACL、时间戳等数据结构，
  又像目录一样可以作为路径标识的一部分，并可以具有子ZNode。
  用户对ZNode具有增、删、改、查等操作（权限允许的情况下）。

- ZNode具有原子性操作，读操作将获取与节点相关的所有数据，写操作也将替换掉节点的所有数据。
  另外，每一个节点都拥有自己的ACL(访问控制列表)，这个列表规定了用户的权限，即限定了特定用户对目标节点可以执行的操作。

- ZNode存储数据大小有限制，ZooKeeper虽然可以关联一些数据，但并没有被设计为常规的数据库或者大数据存储，
  相反的是，它用来管理调度数据，比如分布式应用中的配置文件信息、状态信息、汇集位置等等。
  这些数据的共同特性就是它们都是很小的数据，通常以KB为大小单位。
  ZooKeeper的服务器和客户端都被设计为严格检查并限制每个ZNode的数据大小【至多1M】，当时常规使用中应该远小于此值。

- ZNode通过路径引用，如同Unix中的文件路径。路径必须是绝对的，因此他们必须由斜杠字符来开头。
  除此以外，他们必须是唯一的，也就是说每一个路径只有一个表示，因此这些路径不能改变。
  在ZooKeeper中，路径由Unicode字符串组成，并且有一些限制。字符串"/zookeeper"用以保存管理信息，比如关键配额信息。

  - ① stat：此为状态信息, 描述该ZNode的版本，权限等信息

  - ② data：与该ZNode关联的数据

  - ③ children：该ZNode下的子节点


## 1、zk是如何保存数据的
zk中的数据是保存在节点上的，节点就是ZNode，多个ZNode之间构成一棵树的目录结构。类似于数据结构中的树，同时也很像文件系统的目录。

![zkDirectoryTree01.png](img/02/zkDirectoryTree01.png)

这样的层级结构，让每一个ZNode的节点拥有唯一的路径，就像命名空间一样对不同信息做出清晰的隔离。
```text
# 查看根节点
ls /
```

![lsRootDemo01.png](img/02/lsRootDemo01.png)

## 2、zk中的ZNode是什么样的数据结构
zk中的ZNode包含了四个部分：

1）data：保存数据

2）acl：权限：
```text
c：create 创建权限，允许在该节点下创建子节点

w：write 更新权限，允许更新该节点的数据

r：read 读取权限，允许读取该节点的内容以及子节点的列表信息

d：delete 删除权限，允许删除该节点的子节点信息

a：admin 管理者权限，允许对该节点进行acl权限设置
```

3）stat：描述当前ZNode的元数据

4）child：当前节点的子节点

## 3、zk中节点ZNode的类型
ZNode有两种，分别为临时节点和永久节点。节点的类型在创建时即被确定，并且不能改变。

- 临时节点：该节点的生命周期依赖于创建它们的会话。一旦会话结束，临时节点将被自动删除，当然可以也可以手动删除。【临时节点不允许拥有子节点】。

- 永久节点：该节点的生命周期不依赖于会话，并且只有在客户端显示执行删除操作的时候，他们才能被删除。

ZNode还有一个【序列化】的特性，如果创建的时候指定的话，该ZNode的名字后面会自动追加一个不断增加的序列号。
序列号对于此节点的父节点来说是唯一的，这样便会记录每个子节点创建的先后顺序。
它的格式为“%10d”(10位数字，没有数值的数位用0补充，例如“0000000001”)。

这样便会存在四种类型的ZNode节点，分别对应：

- 1）持久节点：创建出的节点，在会话结束后依然存在。保存数据。

- 2）持久序号节点：创建出的节点，根据先后顺序，会在节点之后带上一个数值，越后执行数值越大，适用于分布式锁的应用场景-单调递增。

- 3）临时节点：临时节点是在会话结束后，自动被删除的，通过这个特性，zk可以实现服务注册与发现的效果。

- 4）临时序号节点：跟持久序号节点相同，适用于临时的分布式锁。

![tmpSeqNodeFlow01.png](img/02/tmpSeqNodeFlow01.png)

5）Container节点（3.5.3版本新增）：Container容器节点，当容器中没有任何子节点，该容器节点会被zk定期删除。

6）TTL节点：可以指定节点的到期时间，到期后被zk定时删除。只能通过系统配置zookeeper.extendedTypeEnable=true开启。

## 4、zk的数据持久化
zk的数据是运行在**内存**中，zk提供了两种持久化机制：

1）事务日志：
  zk把执行的命令以日志形式保存在dataLogDir指定的路径中的文件中（如果没有指定dataLogDir，则按照 dataDir指定的路径）。

2）数据快照：
  zk会在一定的时间间隔内做一次内存数据快照，把时刻的内存数据保存在快照文件中。

zk通过两种形式的持久化，在恢复时先恢复【快照文件】中的数据到内存中，再用【日志文件】中的数据做增量恢复，这样恢复的速度更快。
